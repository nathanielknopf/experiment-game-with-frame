<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Green Square</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <script src="config.js"></script>
    <style type="text/css">
        body {
            margin: 0
        }
    </style>
    <style>
        h3.smallspace {
            line-height: 0.8
        }
    </style>
    <h3 class="smallspace" id="timelabel">Time remaining:</h3>
</head>
<body>

<script type="text/javascript">

var socket = io('/game-nsp')

var param = function( param, use_referrer ) { 
    param = param.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
    var regexS = "[\\?&]"+param+"=([^&#]*)"; 
    var regex = new RegExp( regexS ); 
    var tmpURL = use_referrer ? document.referrer : window.location.href
    var results = regex.exec( tmpURL ); 
    console.log("param: " + param + ", URL: " + tmpURL)
    if( results == null ) { 
        return ""; 
    } else { 
        return results[1];    
    } 
}

socket.on('redirect', function(extension){
    var assignmentId = param("assignmentId", false)
    var hitId = param("hitId", false)
    var workerId = param("workerId", false)
    var turkSubmitTo = param("turkSubmitTo", false)
    var destination = extension + '?assignmentId=' + assignmentId + '&hitId=' + hitId + '&workerId=' + workerId + '&turkSubmitTo=' + turkSubmitTo
    window.location.href = destination
})

socket.on('timer', function(seconds){
    if(seconds == 0){
        document.getElementById("timelabel").innerHTML = "Redirecting you soon..."
    } else {
        document.getElementById("timelabel").innerHTML = "Time remaining: " + seconds + " seconds."
    }
})

var game = new Phaser.Game(720, 540, Phaser.AUTO, '', { preload: preload, create: create, update: update })

function preload() {
    game.load.image('background', 'assets/background.png')
    game.load.image('blob', 'assets/blob.png')
    game.load.image('tree', 'assets/tree.png')
    game.load.image('apple', 'assets/apple.png')
    game.load.image('rock', 'assets/rock.png')
    game.load.image('pond', 'assets/pond.png')
    game.load.image('log', 'assets/log.png')
    game.load.image('fish', 'assets/fish.png')
    // game.load.image('multi_fish', 'assets/multi_fish.png')
}

var player
var platforms
var cursors

var trees
var apples
var rocks
var logs
var fishes
// var multi_fishes
var ponds
var backgrounds

var spacebar
var spacebar_pressed = false

var a
var a_pressed = false

var score = 0

var facing = 'right'

var inventory = {
    pocket: null,
    apples: 1
}

var tree_locations = [{x:350, y:200}, {x:190, y:40}, {x:80, y:220}]
var pond_locations = [{x:220, y:350}, {x:500, y:350}, {x:550, y:100}]
var rock_locations = [{x:10, y:35}, {x:400, y:40}, {x:190, y:120}, {x:85, y:350}, {x:475, y:200}, {x:200, y:450}]
var log_locations = [{x:450, y:480}, {x:600, y:270}, {x:250, y:250}, {x:650, y:450}, {x:400, y:400}, {x:100, y:50}]

function create() {

    game.physics.startSystem(Phaser.Physics.ARCADE)

    backgrounds = game.add.group()
    var background = backgrounds.create(0, 0, 'background')

    trees = game.add.group()
    trees.enableBody = true

    for (var i = 0; i < tree_locations.length; i++){
	   var x = tree_locations[i].x
        var y = tree_locations[i].y
        var tree = trees.create(x, y, 'tree')
        tree.scale.setTo(0.2, 0.2)
        tree.body.immovable = true
    }

    rocks = game.add.group()
    rocks.enableBody = true

    for (var i = 0; i < rock_locations.length; i++){
        var x = rock_locations[i].x
        var y = rock_locations[i].y
        var rock = rocks.create(x, y, 'rock')
        rock.scale.setTo(.11, .15)
    }

    ponds = game.add.group()
    ponds.enableBody = true

    for (var i = 0; i < pond_locations.length; i++){
        var x = pond_locations[i].x
        var y = pond_locations[i].y
        var pond = ponds.create(x, y, 'pond')
        pond.scale.setTo(0.2, 0.2)
    }

    logs = game.add.group()
    logs.enableBody = true

    for (var i = 0; i < log_locations.length; i++){
        var x = log_locations[i].x
        var y = log_locations[i].y
        var log = logs.create(x, y, 'log')
    }

    apples = game.add.group()
    apples.enableBody = true

    fishes = game.add.group()
    fishes.enableBody = true
    multi_fishes = game.add.group()
    multi_fishes = game.add.group()

    player = game.add.sprite(40, game.world.height - 40, 'blob')
    player.anchor.setTo(0.5, 0.5)

    game.physics.arcade.enable(player)
    player.body.collideWorldBounds = true

    cursors = game.input.keyboard.createCursorKeys()

    spacebar = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR)
    a = game.input.keyboard.addKey(Phaser.Keyboard.A)

}

function update() {

    //  Collide the player and the stars with the platforms
    game.physics.arcade.collide(player, trees)
    game.physics.arcade.collide(player, ponds)

    game.physics.arcade.overlap(rocks, trees, rockCollision, null, this)
    game.physics.arcade.overlap(logs, ponds, logCollision, null, this)
    // game.physics.arcade.overlap(apples, ponds, appleCollision, null, thiss)

    game.physics.arcade.overlap(player, rocks, collectRock, null, this)
    game.physics.arcade.overlap(player, logs, collectLog, null, this)
    game.physics.arcade.overlap(player, apples, collectApple, null, this)
    game.physics.arcade.overlap(player, fishes, collectFish, null, this)

    // spacebar
    if (spacebar.isDown){
        if(!spacebar_pressed){
            spacebar_pressed = true
            shootPocket()
        }
    } else if (spacebar.isUp){
        spacebar_pressed = false
    }

    if (a.isDown){
        if(!a_pressed){
            a_pressed = true
            shootApple()
        }
    } else if (a.isUp){
        a_pressed = false
    }

    //  Reset the players velocity (movement)
    player.body.velocity.x = 0
    player.body.velocity.y = 0

    if(cursors.left.isDown || cursors.right.isDown){
    	if (cursors.left.isDown && cursors.right.isDown){
    		player.body.velocity.x = 0
    	} else if (cursors.left.isDown){
    		player.body.velocity.x = -150
            if (facing == 'right'){
                facing = 'left'
                player.scale.setTo(-1, 1)
            }
    	} else if (cursors.right.isDown){
    		player.body.velocity.x = 150
            if (facing == 'left'){
                facing = 'right'
                player.scale.setTo(1, 1)
            }
    	}
    } else {
    	player.body.velocity.x = 0
    }

    if(cursors.up.isDown || cursors.down.isDown){
    	if (cursors.up.isDown && cursors.down.isDown){
    		player.body.velocity.y = 0
    	} else if (cursors.up.isDown){
    		player.body.velocity.y = -150
    	} else if (cursors.down.isDown){
    		player.body.velocity.y = 150
    	}
    } else {
    	player.body.velocity.y = 0
    }
}

function rockCollision(rock, tree){
    console.log("rock collision")
    rock.kill()
    spawnApple(tree)
}

function logCollision(log, pond){
    console.log("log collision")
    log.kill()
    spawnFish(pond)
}

// function appleCollision(apple, pond){
//     console.log("apple collision")
//     apple.kill()
//     spawnMultiFish(pond)
// }

function collectRock(player, rock){
    if(inventory.pocket == null){
        rock.kill()
        inventory.pocket = 'rock'
        socket.emit('rocks', 'rock')
        document.getElementById("pocketlabel").innerHTML = "Pocket: rock"
    }else{
        console.log("Pocket not empty.")
    }
}

function collectLog(player, log){
    if(inventory.pocket == null){
        log.kill()
        inventory.pocket = 'log'
        socket.emit('rocks', 'rock') //this is not true
        document.getElementById("pocketlabel").innerHTML = "Pocket: log"
    }else{
        console.log("Pocket not empty.")
    }
}

function collectApple(player, apple){
    apple.kill()
    score += 1
    inventory.apples += 1
    document.getElementById("scorelabel").innerHTML = "Score: " + score
    console.log("Apple collected.")
    socket.emit('apples', score)
}

function collectFish(player, fish){
    fish.kill()
    score += 1
    document.getElementById("scorelabel").innerHTML = "Score: " + score
    console.log("Fish collected.")
    socket.emit('apples', score)
}

function spawnApple(tree){
    var x = tree.x
    var y = tree.y + 60
    setTimeout(function(){
        var apple = apples.create(x, y, 'apple')
        apple.scale.setTo(.125, .125)
    }, 50)
}

function spawnFish(pond){
    var x = 0
    var y = 0
    //actually fix this
    setTimeout(function(){
        var fish = fishes.create(x, y, 'fish')
    }, 50)
}

// function spawnMultiFish(pond){
//     var x = 0
//     var y = 0
//     setTimeout(function(){
//         var multi_fish = multi_fishes.create(x, y, 'multi_fish')
//     }, 50)
// }

function shootPocket(){
    var speed = (facing == 'right') ? 350 : -350
    if(inventory.pocket != null){
        if(inventory.pocket == 'rock'){
            var offset = (facing == 'right') ? 30 : -55
            var rock = rocks.create(player.x+offset, player.y, 'rock')
            rock.scale.setTo(.11, .15)
            rock.body.velocity.x = speed
        }else if(inventory.pocket == 'log'){
            var offset = (facing == 'right') ? 30 : -55
            var log = logs.create(player.x+offset, player.y, 'log')
            log.body.velocity.x = speed
        }
        inventory.pocket = null
    }else{
        console.log("Pocket empty.")
    }
}

function shootApple(){
    var speed = (facing == 'right') ? 350 : -350
    if(inventory.apples >= 0){
        inventory.apples -= 1
        var offset = (facing == 'right') ? 30 : -55
        var apple = apples.create(player.x+offset, player.y, 'apple')
        apple.scale.setTo(.125, .125)
        apple.body.velocity.x = speed
    }else{
        console.log("No apples in inventory")
    }
}

</script>
<h3 class="smallspace" id="scorelabel">Score: 0</h3>
<h3 class="smallspace" id="pocketlabel">Pocket: empty</h3>
<p id="instructions">Controls: Move with arrow keys, pick up rocks by moving over them, throw rocks by pressing spacebar.<p>
</body>
</html>
