<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Green Square</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <script src="config.js"></script>
    <style type="text/css">
        body {
            margin: 0
        }
    </style>
    <style>
        h3.smallspace {
            line-height: 0.8
        }
        div.fixed {
            position: fixed;
            top: 0;
            right: 0;
            width: 150px;
        }
        .info-box {
            display: inline-block;
            width: 100px;
            height: 80px;
            /*margin: 5px;*/
            border: 3px solid #000000;
        }
        table, th, td {
            border: 1px solid black;
            width: 150px;
        }
    </style>
    <h3 class="smallspace" id="timelabel">Time remaining:</h3>
</head>
<body>

<script type="text/javascript">

var socket = io('/game-nsp')

var param = function(param) { 
    param = param.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
    var regexS = "[\\?&]"+param+"=([^&#]*)"; 
    var regex = new RegExp( regexS ); 
    var tmpURL = window.location.href
    var results = regex.exec( tmpURL ); 
    console.log("param: " + param + ", URL: " + tmpURL)
    if( results == null ) { 
        return ""; 
    } else { 
        return results[1];    
    } 
}

socket.on('redirect', function(extension){
    var assignmentId = param("assignmentId")
    var hitId = param("hitId")
    var workerId = param("workerId")
    var turkSubmitTo = param("turkSubmitTo")
    var condition = param("condition")
    var question_order = param("qord")
    var destination = extension + '?condition=' + condition + '&qord=' + question_order + '&assignmentId=' + assignmentId + '&hitId=' + hitId + '&workerId=' + workerId + '&turkSubmitTo=' + turkSubmitTo
    window.location.href = destination
})

socket.on('timer', function(seconds){
    if(seconds == 0){
        document.getElementById("timelabel").innerHTML = "Redirecting you soon..."
    } else {
        document.getElementById("timelabel").innerHTML = "Time remaining: " + seconds + " seconds."
    }
})

var game = new Phaser.Game(720, 540, Phaser.CANVAS, '', { preload: preload, create: create, update: update })

var player
var facing = 'right'
var cursors

var trees
var apples
var lemons
var grapes
var pineapples

var mountains
var cows
var sheeps
var chickens
var pigs

var rocks

var fruit_score = 0
var animal_score = 0
var pocket = 'empty'

var spacebar
var spacebar_pressed

var condition = (param("condition") == "") ? "a" : param("condition")

var tree_fruit_pairings = {
    'green tree': 'apple',
    'blue tree': 'grape',
    'red tree': 'pineapple',
    'purple tree': 'lemon'
}

var tree_list = [{x:1300, y:60, color: 'red tree'}, {x:720, y:500, color:'green tree'}, {x:900, y: 750, color:'red tree'}, {x:100, y:1000, color:'purple tree'}, {x:370, y:800, color:'blue tree'}, {x:250, y:620, color: 'green tree'}, {x:300, y:500, color:'purple tree'},{x:480, y:140, color: 'blue tree'}, {x:80, y:400, color: 'blue tree'}, {x:700, y:190, color: 'purple tree'}, {x:1200, y:250, color: 'red tree'}, {x:1000, y:300, color: 'green tree'}]

var mountain_animal_pairings = {
    'brown mountain': 'cow',
    'red mountain': 'sheep',
    'green mountain': 'chicken',
    'blue mountain': 'pig'
}

var mountain_list = [{x:500, y:850, color:'red mountain'}, {x:1200, y:740, color:'green mountain'}, {x:700, y:750, color:'brown mountain'}, {x:60, y:150, color: 'red mountain'}, {x:1200, y:500, color:'blue mountain'}, {x:750, y:950, color:'green mountain'},{x:1100, y:850, color:'brown mountain'}, {x:400, y:1000, color:'red mountain'}, {x:200, y:300, color:'blue mountain'}, {x:60, y:800, color: 'green mountain'}, {x:500, y:250, color: 'brown mountain'}, {x:850, y:640, color: 'blue mountain'}]

var rock_list = [{x:100, y:0}, {x:400, y:30}, {x:180, y:150}, {x:320, y:180}, {x:400, y:400}, {x:30, y:1000}, {x:250, y:880}, {x:500, y:650}, {x:60, y:550}, {x:680, y:1000}, {x:200, y:740}, {x:700, y:400}, {x:870, y:30}, {x:1100, y:100}, {x:870, y:320}, {x:1050, y:480}, {x:1200, y:420}, {x:800, y:520}, {x:1400, y:340}, {x:1350, y:970}, {x:900, y:980}, {x:1050, y:750}, {x:1300, y:650}, {x:1150, y:1020}]

function preload() {
    game.load.image('background', 'assets/background.png')
    game.load.image('player', 'assets/player.png')
    game.load.image('rock', 'assets/rock.png')

    game.load.image('red tree', 'assets/tree-red.png')
    game.load.image('blue tree', 'assets/tree-blue.png')
    game.load.image('green tree', 'assets/tree-green.png')
    game.load.image('purple tree', 'assets/tree-purple.png')
    game.load.image('apple', 'assets/apple.png')
    game.load.image('lemon', 'assets/lemon.png')
    game.load.image('grape', 'assets/grape.png')
    game.load.image('pineapple', 'assets/pineapple.png')

    game.load.image('brown mountain', 'assets/mountains-brown.png')
    game.load.image('red mountain', 'assets/mountains-red.png')
    game.load.image('green mountain', 'assets/mountains-green.png')
    game.load.image('blue mountain', 'assets/mountains-blue.png')
    game.load.image('cow', 'assets/cow.png')
    game.load.image('sheep', 'assets/sheep.png')
    game.load.image('chicken', 'assets/chicken.png')
    game.load.image('pig', 'assets/pig.png')
}


function create() {

    game.physics.startSystem(Phaser.Physics.ARCADE)
    game.add.tileSprite(0, 0, 1440, 1080, 'background');
    game.world.setBounds(0, 0, 1440, 1080)

    cursors = game.input.keyboard.createCursorKeys()

    spacebar = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR)

    trees = game.add.group()
    trees.enableBody = true

    for (var i = 0; i < tree_list.length; i++){
        var tree = trees.create(tree_list[i].x, tree_list[i].y, tree_list[i].color)
        tree.body.immovable = true
    }

    for (var i = 0; i < trees.children.length; i++){
        trees.children[i].canSpawnFruit = true
        trees.children[i].colorOfThisTree = tree_list[i].color
    }

    apples = game.add.group()
    apples.enableBody = true

    lemons = game.add.group()
    lemons.enableBody = true

    grapes = game.add.group()
    grapes.enableBody = true

    pineapples = game.add.group()
    pineapples.enableBody = true

    waters = game.add.group()
    waters.enableBody = true

    mountains = game.add.group()
    mountains.enableBody = true

    for (var i = 0; i < mountain_list.length; i++){
        var mountain = mountains.create(mountain_list[i].x, mountain_list[i].y, mountain_list[i].color)
        mountain.body.immovable = true
    }

    for (var i = 0; i < mountains.children.length; i++){
        mountains.children[i].canSpawnAnimal = true
        mountains.children[i].colorOfThisMountain = mountain_list[i].color
    }

    cows = game.add.group()
    cows.enableBody = true

    sheeps = game.add.group()
    sheeps.enableBody = true

    chickens = game.add.group()
    chickens.enableBody = true

    pigs = game.add.group()
    pigs.enableBody = true

    rocks = game.add.group()
    rocks.enableBody = true

    for (var i = 0; i < rock_list.length; i++){
        var rock = rocks.create(rock_list[i].x, rock_list[i].y, 'rock')
        rock.body.immovable = true
    }

    player = game.add.sprite(40, 40, 'player')
    player.anchor.setTo(0.5, 0.5)
    game.physics.arcade.enable(player)
    player.body.collideWorldBounds = true
    game.camera.follow(player)
}

function update() {

    game.physics.arcade.overlap(player, rocks, collectRock, null, this)
    game.physics.arcade.collide(rocks, rocks) //?

    game.physics.arcade.collide(player, trees)
    game.physics.arcade.collide(rocks, trees, treeCollision, null, this)

    game.physics.arcade.overlap(player, apples, collectFruit, null, this)
    game.physics.arcade.overlap(player, pineapples, collectFruit, null, this)
    game.physics.arcade.overlap(player, grapes, collectFruit, null, this)
    game.physics.arcade.overlap(player, lemons, collectFruit, null, this)

    game.physics.arcade.collide(player, mountains)
    game.physics.arcade.collide(rocks, mountains, mountainCollision, null, this)

    game.physics.arcade.overlap(player, cows, collectAnimal, null, this)
    game.physics.arcade.overlap(player, sheeps, collectAnimal, null, this)
    game.physics.arcade.overlap(player, chickens, collectAnimal, null, this)
    game.physics.arcade.overlap(player, pigs, collectAnimal, null, this)

    //  Reset the players velocity (movement)
    player.body.velocity.x = 0
    player.body.velocity.y = 0

    if(cursors.left.isDown || cursors.right.isDown){
    	if (cursors.left.isDown && cursors.right.isDown){
    		player.body.velocity.x = 0
    	} else if (cursors.left.isDown){
    		player.body.velocity.x = -150
            if (facing == 'right'){
                facing = 'left'
                player.scale.setTo(-1, 1)
            }
    	} else if (cursors.right.isDown){
    		player.body.velocity.x = 150
            if (facing == 'left'){
                facing = 'right'
                player.scale.setTo(1, 1)
            }
    	}
    } else {
    	player.body.velocity.x = 0
    }

    if(cursors.up.isDown || cursors.down.isDown){
    	if (cursors.up.isDown && cursors.down.isDown){
    		player.body.velocity.y = 0
    	} else if (cursors.up.isDown){
    		player.body.velocity.y = -150
    	} else if (cursors.down.isDown){
    		player.body.velocity.y = 150
    	}
    } else {
    	player.body.velocity.y = 0
    }

    if(spacebar.isDown && !spacebar_pressed){
        spacebar_pressed = true
        shakeObject()
    }else if(spacebar.isUp && spacebar_pressed){
        spacebar_pressed = false
    }
}

function treeCollision(rock, tree){
    console.log("Tree collision")
    rock.kill()
    for (var i = 0; i < trees.children.length; i++){
        if(trees.children[i].body.position.x == tree.x && trees.children[i].body.position.y == tree.y){
            tree.x += 5
            setTimeout(function(){
                tree.x -= 5
            }, 5)
            setTimeout(function(){
                tree.x += 5
            }, 10)
            setTimeout(function(){
                tree.x -= 5
            }, 15)
            if(trees.children[i].canSpawnFruit){
                var color = trees.children[i].colorOfThisTree
                var fruit = (condition == 'a') ? tree_fruit_pairings[color] : ['apple', 'lemon', 'grape', 'pineapple'][Math.floor(Math.random()*4)]
                spawnFruit(fruit, tree)
                trees.children[i].canSpawnFruit = false
            }
        }
    }
}

function mountainCollision(rock, mountain){
    console.log("Mountain collision")
    rock.kill()
    for (var i = 0; i < mountains.children.length; i++){
        if(mountains.children[i].body.position.x == mountain.x && mountains.children[i].body.position.y == mountain.y){
            mountain.x += 5
            setTimeout(function(){
                mountain.x -= 5
            }, 5)
            setTimeout(function(){
                mountain.x += 5
            }, 10)
            setTimeout(function(){
                mountain.x -= 5
            }, 15)
            if(mountains.children[i].canSpawnAnimal){
                var color = mountains.children[i].colorOfThisMountain
                var animal = (condition == 'a') ? mountain_animal_pairings[color] : ['cow', 'sheep', 'chicken', 'pig'][Math.floor(Math.random()*4)]
                spawnAnimal(animal, mountain)
                mountains.children[i].canSpawnAnimal = false
            }
        }
    }
}

function shootPocket(){
    if (pocket == 'rock'){
        var speed = (facing == 'right') ? 350 : -350
        var offset = (facing == 'right') ? 30 : -55
        var rock = rocks.create(player.x+offset, player.y, 'rock')
        rock.body.velocity.x = speed
        rock.body.collideWorldBounds = true
        socket.emit('action', 'shoot rock')
        pocket = 'empty'
        document.getElementById("pocket-label").src = 'assets/empty.png'
    }else{
        console.log("Pocket empty, cannot throw")
        socket.emit('action', 'shoot empty pocket')
    }
}

function collectRock(player, rock){
    if (pocket == 'empty'){
        rock.kill()
        pocket = 'rock'
        document.getElementById("pocket-label").src = 'assets/rock.png'
    }
}

function spawnFruit(fruit, tree){
    var x = tree.x
    var y = (tree.body.touching.down) ? tree.y-40 : tree.y+60
    setTimeout(function(){
        if (fruit == 'apple'){
            var apple = apples.create(x, y, 'apple')
        }else if(fruit == 'lemon'){
            var lemon = lemons.create(x, y, 'lemon')
        }else if(fruit == 'grape'){
            var grape = grapes.create(x, y, 'grape')
        }else if(fruit == 'pineapple'){
            var pineapple = pineapples.create(x, y, 'pineapple')
        }
    })
}

function spawnAnimal(animal, mountain){
    var x = mountain.x
    var y = (mountain.body.touching.down) ? mountain.y-40 : mountain.y+60
    setTimeout(function(){
        if (animal == 'cow'){
            var cow = cows.create(x, y, 'cow')
        }else if(animal == 'sheep'){
            var sheep = sheeps.create(x, y, 'sheep')
        }else if(animal == 'chicken'){
            var chicken = chickens.create(x, y, 'chicken')
        }else if(animal == 'pig'){
            var pig = pigs.create(x, y, 'pig')
        }
    })
}

function collectFruit(player, fruit){
    console.log("collected: " + fruit.key)
    socket.emit('action', 'get ' + fruit.key)
    fruit.kill()
    fruit_score += 1
    document.getElementById("fruit-label").innerHTML = "Fruits: " + fruit_score
}

function collectAnimal(player, animal){
    console.log("collected: " + animal.key)
    socket.emit('action', 'get ' + animal.key)
    animal.kill()
    animal_score += 1
    document.getElementById("animal-label").innerHMTL = "Animals: " + animal_score
}

</script>
<div class="info-box"><h3>Pocket<img id="pocket-label" src="assets/empty.png" align="right" onclick="shootPocket()" style="margin:3px;width:30px;height:30px;"></h3></div>
<div class="info-box"><h3 id="fruit-label">Fruit: 0</h3></div>
<div class="info-box"><h3 id="animal-label">Animals: 0</h3></div>
<!-- <h3 class="smallspace" id="pocketlabel">Pocket: empty</h3> -->
<div class="fixed">
    <table>
        <tr>
            <th>Object</th>
            <th>Points</th>
        </tr>
        <tr>
            <td>Rock</td>
            <td>0 points</td>
        </tr>
        <tr>
            <td>Log</td>
            <td>0 points</td>
        </tr>
        <tr>
            <td>Apple</td>
            <td>1 points</td>
        </tr>
        <tr>
            <td>Fish</td>
            <td>2 points</td>
        </tr>
    </table>
</div>
</body>
</html>
