<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Green Square</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <script src="config.js"></script>
    <style type="text/css">
        body {
            margin: 0
        }
    </style>
    <style>
        h3.smallspace {
            line-height: 0.8
        }
        div.fixed {
            position: fixed;
            top: 0;
            right: 0;
            width: 150px;
        }
        table, th, td {
            border: 1px solid black;
            width: 150px;
        }
    </style>
    <h3 class="smallspace" id="timelabel">Time remaining:</h3>
</head>
<body>

<script type="text/javascript">

var socket = io('/game-nsp')

var param = function( param, use_referrer ) { 
    param = param.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
    var regexS = "[\\?&]"+param+"=([^&#]*)"; 
    var regex = new RegExp( regexS ); 
    var tmpURL = use_referrer ? document.referrer : window.location.href
    var results = regex.exec( tmpURL ); 
    console.log("param: " + param + ", URL: " + tmpURL)
    if( results == null ) { 
        return ""; 
    } else { 
        return results[1];    
    } 
}

socket.on('redirect', function(extension){
    var assignmentId = param("assignmentId", false)
    var hitId = param("hitId", false)
    var workerId = param("workerId", false)
    var turkSubmitTo = param("turkSubmitTo", false)
    var destination = extension + '?assignmentId=' + assignmentId + '&hitId=' + hitId + '&workerId=' + workerId + '&turkSubmitTo=' + turkSubmitTo
    window.location.href = destination
})

socket.on('timer', function(seconds){
    if(seconds == 0){
        document.getElementById("timelabel").innerHTML = "Redirecting you soon..."
    } else {
        document.getElementById("timelabel").innerHTML = "Time remaining: " + seconds + " seconds."
    }
})

var game = new Phaser.Game(720, 540, Phaser.CANVAS, '', { preload: preload, create: create, update: update })

var player
var facing = 'right'
var cursors

var trees
var apples
var rocks
var logs
var fishes
var ponds
var backgrounds

var spacebar
var spacebar_pressed = false

var a
var a_pressed = false
var r
var r_pressed = false
var l
var l_pressed = false
var f
var f_pressed = false


var inventory = {
    pocket: null,
    apples: 0,
    fish: 0,
}

var tree_list = [{x:350, y:200, n:5}, {x:190, y:40, n:5}, {x:80, y:220, n:5}]
var pond_list = [{x:220, y:350, n:5}, {x:500, y:350, n:5}, {x:550, y:100, n:5}]
var rock_locations = [{x:10, y:35}, {x:400, y:40}, {x:190, y:120}, {x:85, y:350}, {x:475, y:200}, {x:100, y:450}]
var log_locations = [{x:450, y:480}, {x:600, y:270}, {x:250, y:250}, {x:650, y:450}, {x:400, y:400}, {x:100, y:50}]

function preload() {
    game.load.image('background', 'assets/background.png')
    game.load.image('blob', 'assets/blob.png')
    game.load.image('tree', 'assets/tree.png')
    game.load.image('apple', 'assets/apple.png')
    game.load.image('rock', 'assets/rock.png')
    game.load.image('pond', 'assets/pond.png')
    game.load.image('log', 'assets/log.png')
    game.load.image('fish', 'assets/fish.png')
}


function create() {

    game.physics.startSystem(Phaser.Physics.ARCADE)
    game.world.setBounds(1440, 540)

    cursors = game.input.keyboard.createCursorKeys()

    a = game.input.keyboard.addKey(Phaser.Keyboard.A)
    r = game.input.keyboard.addKey(Phaser.Keyboard.R)
    l = game.input.keyboard.addKey(Phaser.Keyboard.L)
    f = game.input.keyboard.addKey(Phaser.Keyboard.F)

    // backgrounds = game.add.group()
    // var background = backgrounds.create(0, 0, 'background')

    game.add.tileSprite(0, 0, 1440, 540, 'background');

    trees = game.add.group()
    trees.enableBody = true

    for (var i = 0; i < tree_list.length; i++){
	   var x = tree_list[i].x
        var y = tree_list[i].y
        var tree = trees.create(x, y, 'tree')
        tree.scale.setTo(0.2, 0.2)
        tree.body.immovable = true
    }

    rocks = game.add.group()
    rocks.enableBody = true

    for (var i = 0; i < rock_locations.length; i++){
        var x = rock_locations[i].x
        var y = rock_locations[i].y
        var rock = rocks.create(x, y, 'rock')
        rock.scale.setTo(.11, .15)
    }

    ponds = game.add.group()
    ponds.enableBody = true

    for (var i = 0; i < pond_list.length; i++){
        var x = pond_list[i].x
        var y = pond_list[i].y
        var pond = ponds.create(x, y, 'pond')
        pond.scale.setTo(0.4, 0.4)
        pond.body.immovable = true
    }

    logs = game.add.group()
    logs.enableBody = true

    for (var i = 0; i < log_locations.length; i++){
        var x = log_locations[i].x
        var y = log_locations[i].y
        var log = logs.create(x, y, 'log')
        log.scale.setTo(0.2, 0.2)
    }

    apples = game.add.group()
    apples.enableBody = true

    fishes = game.add.group()
    fishes.enableBody = true

    player = game.add.sprite(40, game.world.height - 40, 'blob')
    player.anchor.setTo(0.5, 0.5)
    game.camera.follow(player)

    game.physics.arcade.enable(player)
    player.body.collideWorldBounds = true
}

function update() {

    //  Collide the player and the stars with the platforms
    game.physics.arcade.collide(player, trees)
    game.physics.arcade.collide(player, ponds)
    game.physics.arcade.collide(logs, trees)
    game.physics.arcade.collide(rocks, ponds)
    game.physics.arcade.collide(rocks, apples)
    game.physics.arcade.collide(fishes, trees)
    game.physics.arcade.collide(fishes, ponds)
    game.physics.arcade.collide(fishes, apples)
    game.physics.arcade.collide(fishes, rocks)
    game.physics.arcade.collide(apples, trees)

    game.physics.arcade.overlap(rocks, trees, rockCollision, null, this)
    game.physics.arcade.overlap(logs, ponds, logCollision, null, this)
    game.physics.arcade.overlap(apples, ponds, appleCollision, null, this)

    game.physics.arcade.overlap(player, rocks, collectRock, null, this)
    game.physics.arcade.overlap(player, logs, collectLog, null, this)
    game.physics.arcade.overlap(player, apples, collectApple, null, this)
    game.physics.arcade.overlap(player, fishes, collectFish, null, this)

    if (a.isDown){
        if(!a_pressed){
            a_pressed = true
            shoot('apple')
        }
    } else if (a.isUp){
        a_pressed = false
    }

    if (r.isDown){
        if(!r_pressed){
            r_pressed = true
            shoot('rock')
        }   
    }else if (r.isUp){
        r_pressed = false
    }

    if (l.isDown){
        if(!l_pressed){
            l_pressed = true
            shoot('log')
        }   
    }else if (l.isUp){
        l_pressed = false
    }

    if (f.isDown){
        if(!f_pressed){
            f_pressed = true
            shoot('fish')
        }   
    }else if (f.isUp){
        f_pressed = false
    }

    //  Reset the players velocity (movement)
    player.body.velocity.x = 0
    player.body.velocity.y = 0

    if(cursors.left.isDown || cursors.right.isDown){
    	if (cursors.left.isDown && cursors.right.isDown){
    		player.body.velocity.x = 0
    	} else if (cursors.left.isDown){
    		player.body.velocity.x = -150
            if (facing == 'right'){
                facing = 'left'
                player.scale.setTo(-1, 1)
            }
    	} else if (cursors.right.isDown){
    		player.body.velocity.x = 150
            if (facing == 'left'){
                facing = 'right'
                player.scale.setTo(1, 1)
            }
    	}
    } else {
    	player.body.velocity.x = 0
    }

    if(cursors.up.isDown || cursors.down.isDown){
    	if (cursors.up.isDown && cursors.down.isDown){
    		player.body.velocity.y = 0
    	} else if (cursors.up.isDown){
    		player.body.velocity.y = -150
    	} else if (cursors.down.isDown){
    		player.body.velocity.y = 150
    	}
    } else {
    	player.body.velocity.y = 0
    }
}

function rockCollision(rock, tree){
    console.log("rock collision")
    rock.kill()
    for (var i = 0; i < tree_list.length; i++){
        if (tree_list[i].x == tree.x && tree_list[i].y == tree.y){
            if (tree_list[i].n > 0){
                spawnApple(tree.x, tree.y+60)
                tree_list[i].n -= 1
            }
        }
    }
}

function logCollision(log, pond){
    console.log("log collision")
    log.kill()
    for (var i = 0; i < pond_list.length; i++){
        if (pond_list[i].x == pond.x && pond_list[i].y == pond.y){
            if (pond_list[i].n > 0){
                spawnFish(pond.x, pond.y + 80, 1)
                pond_list[i].n -= 1
            }
        }
    }
}

function appleCollision(apple, pond){
    console.log("apple collision")
    apple.kill()
    for (var i = 0; i < pond_list.length; i++){
        if (pond_list[i].x == pond.x && pond_list[i].y == pond.y){
            if (pond_list[i].n >= 3){
                spawnFish(pond.x, pond.y + 80, 3)
                pond_list[i].n -= 3
            }else if (pond_list[i].n > 0){
                spawnFish(pond.x, pond.y + 80, pond_list[i].n)
                pond_list[i].n = 0
            }
        }
    }
}

function collectRock(player, rock){
    if(inventory.pocket == null){
        rock.kill()
        inventory.pocket = 'rock'
        socket.emit('rocks')
        document.getElementById("pocketlabel").innerHTML = "Pocket: rock"
    }else{
        console.log("Pocket not empty.")
    }
}

function collectLog(player, log){
    if(inventory.pocket == null){
        log.kill()
        inventory.pocket = 'log'
        socket.emit('logs') //this is not true
        document.getElementById("pocketlabel").innerHTML = "Pocket: log"
    }else{
        console.log("Pocket not empty.")
    }
}

function collectApple(player, apple){
    apple.kill()
    inventory.apples += 1
    document.getElementById("scorelabel").innerHTML = "Apples: " + inventory.apples + ", Fish: " + inventory.fish
    console.log("Apple collected.")
    socket.emit('apples', 'more')
}

function collectFish(player, fish){
    fish.kill()
    inventory.fish += 1
    document.getElementById("scorelabel").innerHTML = "Apples: " + inventory.apples + ", Fish: " + inventory.fish
    console.log("Fish collected.")
    socket.emit('fishes', 'more')
}

function spawnApple(x, y){
    setTimeout(function(){
        var apple = apples.create(x, y, 'apple')
        apple.scale.setTo(.125, .125)
    }, 50)
}

function spawnFish(x, y, n){
    var fish_x = x
    var fish_y = y
    setTimeout(function() {
        for(var i = 0; i < n; i++){
            var fish = fishes.create(fish_x, fish_y, 'fish')
            fish.scale.setTo(0.125, 0.125)
            fish_y += 30
        }
    }, 50)
}

function shoot(item){
    var speed = (facing == 'right') ? 350 : -350
    if (item == 'apple'){
        if(inventory.apples > 0){
            inventory.apples -= 1
            var offset = (facing == 'right') ? 30 : -55
            var apple = apples.create(player.x+offset, player.y, 'apple')
            apple.scale.setTo(0.125, 0.125)
            apple.body.velocity.x = speed
            apple.body.collideWorldBounds = true
            document.getElementById("scorelabel").innerHTML = "Apples: " + inventory.apples + ", Fish: " + inventory.fish
            socket.emit('apples', 'less')
        }else{
            console.log("No apples in inventory")
        }
    } else if (item == 'fish'){
        if(inventory.fish > 0){
            inventory.fish -= 1
            var offset = (facing == 'right') ? 30 : -55
            var fish = fishes.create(player.x+offset, player.y, 'fish')
            fish.scale.setTo(0.125, 0.125)
            fish.body.velocity.x = speed
            fish.body.collideWorldBounds = true
            document.getElementById("scorelabel").innerHTML = "Apples: " + inventory.apples + ", Fish: " + inventory.fish
            socket.emit('fishes', 'less')
        }else{
            console.log("No fish in inventory")
        }
    } else if (item == 'log'){
        if(inventory.pocket == 'log'){
            var offset = (facing == 'right') ? 30 : -80
            var log = logs.create(player.x+offset, player.y, 'log')
            log.scale.setTo(0.2, 0.2)
            log.body.velocity.x = speed
            log.body.collideWorldBounds = true
            inventory.pocket = null
            socket.emit('pocket empty')
            document.getElementById("pocketlabel").innerHTML = "Pocket: empty"
        }else{
            console.log("Pocket empty. Cannot throw log.")
        }
    }else if (item == 'rock'){
        if(inventory.pocket == 'rock'){
            var offset = (facing == 'right') ? 30 : -55
            var rock = rocks.create(player.x+offset, player.y, 'rock')
            rock.scale.setTo(0.11, 0.15)
            rock.body.velocity.x = speed
            rock.body.collideWorldBounds = true
            inventory.pocket = null
            socket.emit('pocket empty')
            document.getElementById("pocketlabel").innerHTML = "Pocket: empty"
        }else{
            console.log("Pocket empty. Cannot throw log.")
        }
    }
}

</script>
<h3 id="scorelabel">Apples: 0, Fish: 0</h3>
<h3 class="smallspace" id="pocketlabel">Pocket: empty</h3>
<div class="fixed">
    <table>
        <tr>
            <th>Object</th>
            <th>Points</th>
        </tr>
        <tr>
            <td>Rock</td>
            <td>0 points</td>
        </tr>
        <tr>
            <td>Log</td>
            <td>0 points</td>
        </tr>
        <tr>
            <td>Apple</td>
            <td>1 points</td>
        </tr>
        <tr>
            <td>Fish</td>
            <td>2 points</td>
        </tr>
    </table>
</div>
</body>
</html>
